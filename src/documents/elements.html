<link rel="import" href="#{SITE_URL}bower_components/polymer/polymer.html" />

<!--
The InterConnect Person
This is just for debugging and outputs the relevant fields when we get it
-->
<polymer-element name="ic-person" attributes="name stream streamURI snapshot">
	<template>
		Hi, I'm <strong>{{name}}</strong><br/>
		I have a stream located at: <strong>{{streamURI}}</strong>
	</template>
	<script>
		Polymer('ic-person', {
			name: Math.random(),
			stream: null,
			streamURI: null,
			snapshot: null
		});
	</script>
</polymer-element>


<!--
The RTC Media
This is what captures the media and exports it as a stream and streamURI
-->
<polymer-element name="rtc-media" attributes="stream muted capture streamURI">
	<script src="//wzrd.in/bundle/rtc-media@latest"></script>
	<script src="//wzrd.in/bundle/rtc-captureconfig@latest"></script>
	<script>
		Polymer('rtc-media', {
			muted: true,
			capture: 'camera max:320x240',
			ready: function(){
				var me = this;
				var constraints = require('rtc-captureconfig')(me.capture).toConstraints();
				var media = require("rtc-media")({
					muted: me.muted,
					constraints: constraints
				});
				media.once('capture', function(stream){
					me.stream = stream;
					me.streamURI = media._createObjectURL(stream);
				});
			}
		});
	</script>
</polymer-element>

<!--
The RTC Video
This displays our streamURI as a playing video
-->
<polymer-element name="rtc-video" attributes="streamURI vid">
	<template>
		<video id="vid" mozSrcObject="{{streamURI}}" src="{{streamURI}}" preserveaspectratio></video>
	</template>
	<script>
		Polymer('rtc-video', {
			streamURIChanged: function(oldValue, newValue) {
				var me = this;
				if ( newValue ) {
					setTimeout(function(){
						me.$.vid.play();
						me.vid = me.$.vid;
					},0);
				}
			}
		});
	</script>
</polymer-element>

<!--
This RTC VideoProc
This takes a streamURI and generates an imageURI with the filters applied
-->
<polymer-element name="rtc-videoproc" attributes="streamURI filter fps mime quality greedy imageURI">
	<script src="//wzrd.in/bundle/rtc-videoproc@latest"></script>
	<template></template>
	<script>
		var filters = {
			bw: function(imageData) {
				var channels = imageData.data;
				var rgb = [];
				var rgbAvg;
				var alpha;
				var ii;

				// check that we have channels is divisible by four (just as a safety)
				if (channels.length % 4 !== 0) {
					return;
				}

				// iterate through the data
				// NOTE: decrementing loops are fast but you need to know that you will
				// hit 0 using this logic otherwise it will run forever (only 0 is falsy)
				for (ii = channels.length; ii -= 4; ) {
					// get the rgb tuple
					rgb = [channels[ii], channels[ii + 1], channels[ii + 2]];

					// get the alpha value
					alpha = channels[ii + 3];

					// calculate the rgb average
					rgbAvg = (rgb[0] + rgb[1] + rgb[2] ) / 3;

					// update the values to the rgb average
					channels[ii] = channels[ii + 1] = channels[ii + 2] = rgbAvg;
				}

				return true;
			}
		};

		Polymer('rtc-videoproc', {
			fps: 0.5,
			mime: 'image/jpeg',
			quality: 0.8,
			greedy: true,
			filter: null,
			vidChanged: function(oldValue, newValue) {
				var me = this;
				if ( newValue ) {
					var canvas = require('rtc-videoproc')(newValue, {
						fps: me.fps,
						greedy: me.greedy
					});

					document.appendChild(canvas);

					if ( me.filter ) {
						var filter = filters[me.filter];
						canvas.pipeline.add(filter);
					}

					canvas.addEventListener('postprocess', function(event){
						me.imageURI = canvas.toDataURL(me.mime, me.quality);
					});
				}
			}
		});
	</script>
</polymer-element>


<!--
The Interconnect App
This is our application that ties everything together
-->
<polymer-element name="ic-app">
	<template>
		<ic-person streamURI="{{myStreamURI}}"></ic-person>
		<rtc-media streamURI="{{myStreamURI}}"></rtc-media>
		<rtc-video streamURI="{{myStreamURI}}" vid="#{{myVid}}"></rtc-video>
		<rtc-videoproc vid="{{myVid}}" filter="bw"></rtc-videoproc>

		<!--
		<div class="peers">
			<ic-person bandwidth="high"></ic-person>
			<ic-person></ic-person>
			<ic-person></ic-person>
			<ic-person></ic-person>
			<ic-person></ic-person>
		</div>
		-->

	</template>
	<script>
		Polymer('ic-app', {});
	</script>
</polymer-element>


<polymer-element name="test-a" attributes="el">
	<template>
		<span id="el">the el</span>
	</template>
	<script>
		Polymer('test-a', {
			ready: function(){
				me.el = me.$.el;
			}
		});
	</script>
</polymer-element>

<polymer-element name="test-b" attributes="el">
	<template></template>
	<script>
		Polymer('test-a', {
			elChanged: function(oldValue, newValue){
				me.el.setAttribute('id', 'el');
				me.el.innerText = 'sup';
				if ( oldValue )  me.$.removeChild(me.$.el);
				if ( newValue )  me.$.appendChild(me.el);
			}
		});
	</script>
</polymer-element>

<polymer-element name="test-c" noscript>
	<template>
		<test-a el="{{el}}"></test-a>
		<test-b el="{{el}}"></test-b>
	</template>
</polymer-element>